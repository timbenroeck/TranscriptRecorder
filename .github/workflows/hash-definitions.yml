name: Hash Source & Tool Definitions

on:
  push:
    branches: [main]
    paths:
      - 'sources/**/source.json'
      - 'tools/**/tool.json'

permissions:
  contents: write

jobs:
  hash:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Full fetch so we can push back
          fetch-depth: 0

      - name: Compute SHA-256 hashes
        run: |
          changed=0

          # Hash every source.json
          for f in sources/*/source.json; do
            [ -f "$f" ] || continue
            hash=$(sha256sum "$f" | awk '{print $1}')
            hash_file="${f}.sha256"
            existing=""
            [ -f "$hash_file" ] && existing=$(cat "$hash_file")
            if [ "$hash" != "$existing" ]; then
              echo "$hash" > "$hash_file"
              echo "Updated $hash_file"
              changed=1
            fi
          done

          # Hash every tool.json
          for f in tools/*/tool.json; do
            [ -f "$f" ] || continue
            hash=$(sha256sum "$f" | awk '{print $1}')
            hash_file="${f}.sha256"
            existing=""
            [ -f "$hash_file" ] && existing=$(cat "$hash_file")
            if [ "$hash" != "$existing" ]; then
              echo "$hash" > "$hash_file"
              echo "Updated $hash_file"
              changed=1
            fi
          done

          echo "changed=$changed" >> "$GITHUB_ENV"

      - name: Commit updated hashes
        if: env.changed == '1'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add '*.sha256'
          git commit -m "ci: update definition hashes [ci skip]"
          git push
