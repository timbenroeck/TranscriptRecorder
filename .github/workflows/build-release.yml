name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Triggers on version tags like v1.0.0
  workflow_dispatch:  # Allows manual triggering

jobs:
  build:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install py2app
      
      - name: Get version
        id: version
        run: |
          VERSION=$(python -c "from version import __version__; print(__version__)")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Build application
        run: |
          python setup_py2app.py py2app
      
      - name: Create DMG
        run: |
          # Create a DMG from the app bundle
          APP_NAME="Transcript Recorder"
          DMG_NAME="TranscriptRecorder-${{ steps.version.outputs.version }}.dmg"
          
          # Create a temporary directory for DMG contents
          mkdir -p dmg_contents
          cp -R "dist/$APP_NAME.app" dmg_contents/
          
          # Create Applications symlink
          ln -s /Applications dmg_contents/Applications
          
          # Create DMG
          hdiutil create -volname "$APP_NAME" \
            -srcfolder dmg_contents \
            -ov -format UDZO \
            "dist/$DMG_NAME"
          
          # Clean up
          rm -rf dmg_contents
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: TranscriptRecorder-${{ steps.version.outputs.version }}
          path: |
            dist/*.dmg
            dist/*.app
      
      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*.dmg
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
