name: Validate Repo

on:
  push:
    branches: [main]
    paths:
      - 'rules/**'
      - 'tools/**'
      - 'bundle.json'
  pull_request:
    paths:
      - 'rules/**'
      - 'tools/**'
      - 'bundle.json'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for reserved rule names
        run: |
          RESERVED="manual"
          if [ -d "rules/$RESERVED" ]; then
            echo "::error::rules/$RESERVED/ is a reserved name used by the built-in Manual Recording rule. Rename this directory."
            exit 1
          fi
          echo "No reserved name conflicts found."

      - name: Validate bundle.json
        run: |
          if [ ! -f bundle.json ]; then
            echo "::error::bundle.json not found â€” the build will not bundle any rules or tools."
            exit 1
          fi
          python3 -c "
          import json, sys
          with open('bundle.json') as f:
              manifest = json.load(f)
          errors = []
          for rule in manifest.get('rules', []):
              if rule == 'manual':
                  errors.append(f\"bundle.json lists reserved rule name 'manual'\")
          for kind in ('rules', 'tools'):
              for name in manifest.get(kind, []):
                  import os
                  if not os.path.isdir(os.path.join(kind, name)):
                      errors.append(f'bundle.json lists {kind}/{name} but directory not found')
          if errors:
              for e in errors:
                  print(f'::error::{e}')
              sys.exit(1)
          print('bundle.json is valid.')
          "
